# Model 矩阵

这个要计算的是在 Object 上的某一个点，以世界坐标 origin 为中心，经过缩放以及平移后所在的位置

# View 矩阵

这个实际上要计算的是在 Object 上的某一个点，他在 Camera 的局部坐标系中，应该是什么坐标，本质就是问，这个点相对于 Camera 的位置是多少。
那么这个东西其实是有一个非常明了的公式：

$ \mathbf{p} = \mathbf{p}_{camera} + \mathbf{p}' $

其中，$ \mathbf{p} $ 是那个点在世界坐标系中的位置，$ \mathbf{p}_{camera} $ 是 Camera 在世界坐标系中的位置，$ \mathbf{p}' $ 是那个点相对于 Camera 的位置。相对于 Camera 的位置 其实就是算这个点 在 Camera 的坐标系中，他的投影分量是多少，假设这个投影分量是 
$
\begin{bmatrix}
x' \\
y' \\
z'
\end{bmatrix}
$
，然后 Camera 的基底是 { $ e_1', e_2', e_3' $ }
，那么有下面的等式

$ \mathbf{p}' =  
\begin{bmatrix}
\,|\, & \,|\, & \,|\, \\
e_1' & e_2' & e_3'\\
\,|\, & \,|\ & \,|\,
\end{bmatrix}
\begin{bmatrix}
x' \\
y' \\
z'
\end{bmatrix}
$

那么，要求
$
\begin{bmatrix}
x' \\
y' \\
z'
\end{bmatrix}
$
就会很简单了，直接反推即可


$ \begin{bmatrix}
\,|\, & \,|\, & \,|\, \\
e_1' & e_2' & e_3'\\
\,|\, & \,|\ & \,|\,
\end{bmatrix}^{-1}(\mathbf{p} - \mathbf{p}_{camera}) = \begin{bmatrix}
x' \\
y' \\
z'
\end{bmatrix}  $

其中，因为{ $ e_1', e_2', e_3' $ } 基底互相垂直，所以 
$\begin{bmatrix}
\,|\, & \,|\, & \,|\, \\
e_1' & e_2' & e_3'\\
\,|\, & \,|\ & \,|\,
\end{bmatrix}$  是个正交矩阵，他的逆矩阵是 
$\begin{bmatrix}
\,-\, & \,e_1'\, & \,-\, \\
\,-\ & e_2' & -\\
\,-\, & \,e_3'\ & \,-\,
\end{bmatrix}$ 

因此，求取这个 View Matrix 是很简单的，只需要 Camera 的 Position，以及 Camera 的基底，而 Camera 的基底，一般都是通过 LookDir 以及 Camera 的 Right 来算出来，这里不再赘述，算出基底后，就能拼出那个逆矩阵，有了逆矩阵，还没结束，我们知道 $(\mathbf{p} - \mathbf{p}_{camera}) $ 其实就是一个位移分量，把这个位移分量再拼上前面的3x3逆矩阵，就能得到一个完整4x4齐次矩阵。也就是

$\begin{bmatrix}
\,-\, & \,e_1'\, & \,-\, & \,-C_{x}\,\\
\,-\ & e_2' & -& \,-C_{y}\,\\
\,-\, & \,e_3'\ & \,-\,& \,-C_{z}\,\\
\,0\, & \,0\ & \,0\,& \,1\,\\
\end{bmatrix}$ 
$C$ 表示 Camera 的 Position 



<br>

# PROJECT 矩阵

印象中总会觉得投影矩阵特别难推理，其实很简单，主要是以前一直没弄清楚他的一些严格定义，今天完整推导一次

![alt text](images/img_proj.png)

首先，我们从俯视图出发，这里的世界坐标原点在点 $ O $, 然后往右是 $z$ 轴正方向，往上是 $x$ 轴正方向，而点 $P$ 是我们在 View 空间坐标系中的一个点，记他的坐标为 $(x, y, z)$, 然后点 $P$ 经过投影后变成点 $P'$（坐标是$(x', y', z')$），实际上就是连接 $OP$ 然后穿过平面 $DE$ （俯视图来看就是一个线段），经过的交点就是点 $P'$，稍微补充一下，$DE$ 是近平面，距离点 $O$ 的垂直距离是 $n$，而 $BC$ 是远平面，距离原点是 $f$。那么我们的目标就是用一个矩阵乘上$(x, y, z)$后得到点$P'$的坐标，因此我们需要先确定点$P'$的坐标是多少。

稍微用点三角形的相似原理，你就能推出 $x' = \dfrac{nx}{z}$，同理，上面的图如果不是俯视图，而是右视图，你也能推出  $y' = \dfrac{ny}{z}$，那么我们现在好奇的是 $z'$ 是多少？所以这里引出
近平面和远平面的作用，他其实是三个限定条件，点如果不在近平面和原平面之间，将不会有投影点，而如果一个点在近平面上，则他的投影点的$z'$值，将会是 $0$，而如果一个点在远平面上，则他的投影点的$z'$值，将会是 $1$。这是一种归一化的限定，并没有说非得这样弄（像 opengl 就不是这样，是[-1, 1]），你完全可以用别的标准去设计你的$z'$值，只不过目前业界都用这一套。上面的话用表达式表示就是

if $P$ is $(\;x, \;y, \;n\;)$

then $P'$ = $(\;\dfrac{nx}{z}, \;\dfrac{ny}{z}, \;0\;)$

if $P$ is $(\;x, \;y, \;f\;)$

then $P'$ = $(\;\dfrac{nx}{z}, \;\dfrac{ny}{z}, \;1\;)$

if $P$ is $(\;x, \;y, \;z\;)$

then $P'$ = $(\;\dfrac{nx}{z}, \;\dfrac{ny}{z}, \;[0, 1]\;)$




我们想用一个 **常量** 矩阵（齐次矩阵）来乘上 $P$ 得到 $P'$，那么应该如何想呢？上面的表达式可以再写的更具体一点


$\begin{bmatrix}
\,-\, & \,e_1\, & \,-\, & \,-\,\\
\,-\ & e_2 & -& \,-\,\\
\,-\, & \,e_3\ & \,-\,& \,-\,\\
\,-\, & \,e_4\ & \,-\,& \,-\,\\
\end{bmatrix}
\begin{bmatrix}
x \\
y \\
n \\
1
\end{bmatrix}=\begin{bmatrix}
\dfrac{nx}{n} \\
\\
\dfrac{ny}{n} \\
\\
0 \\
\\
-\\
\end{bmatrix}
\;\;\;\;(1)
$

$\begin{bmatrix}
\,-\, & \,e_1\, & \,-\, & \,-\,\\
\,-\ & e_2 & -& \,-\,\\
\,-\, & \,e_3\ & \,-\,& \,-\,\\
\,-\, & \,e_4\ & \,-\,& \,-\,\\
\end{bmatrix}
\begin{bmatrix}
x \\
y \\
f \\
1
\end{bmatrix}=\begin{bmatrix}
\dfrac{nx}{f} \\
\\
\dfrac{ny}{f} \\
\\
1 \\
\\
-\\
\end{bmatrix}
\;\;\;\;(2)
$

$\begin{bmatrix}
\,-\, & \,e_1\, & \,-\, & \,-\,\\
\,-\ & e_2 & -& \,-\,\\
\,-\, & \,e_3\ & \,-\,& \,-\,\\
\,-\, & \,e_4\ & \,-\,& \,-\,\\
\end{bmatrix}
\begin{bmatrix}
x \\
y \\
z \\
1
\end{bmatrix}=\begin{bmatrix}
\dfrac{nx}{z} \\
\\
\dfrac{ny}{z} \\
\\
-\\
\\
-\\
\end{bmatrix}
\;\;\;\;(3)
$


由 $(3)$ 的矩阵可以得到一个东西，
$\begin{bmatrix}
\,-\, & \,e_1\ & \,-\,& \,-\,\\
\end{bmatrix}
\begin{bmatrix}
x \\
y \\
-\\
1
\end{bmatrix}=\dfrac{nx}{z}
$
，而这是不可能的，$\dfrac{nx}{z}$ 包含两个变量，无法通过 $ax+by+cz+d$ 这样的线性变换得到，因此无法通过乘一个矩阵得到这个结果，我们可以通过矩阵变换出别的，再通过某个手段得到这个目标变量，比如改成这样子

if $P$ is $(\;x, \;y, \;z\;)$

then $P'$ = $(\;nx, \;ny, \;[0, z], \;z\;)$

其实就是 scale 整个分量，并且让 $w$ 分量变换后变成 $z$，这样的话，想要得到原来的分量，只需要执行一次 除$w$ 的操作即可。那么上面的三个式子就变成下面的情况：

$\begin{bmatrix}
\,-\, & \,e_1\, & \,-\, & \,-\,\\
\,-\ & e_2 & -& \,-\,\\
\,-\, & \,e_3\ & \,-\,& \,-\,\\
\,-\, & \,e_4\ & \,-\,& \,-\,\\
\end{bmatrix}
\begin{bmatrix}
x \\
y \\
n \\
1
\end{bmatrix}=\begin{bmatrix}
nx \\
\\
ny \\
\\
0 \\
\\
n\\
\end{bmatrix}
\;\;\;\;(1)
$

$\begin{bmatrix}
\,-\, & \,e_1\, & \,-\, & \,-\,\\
\,-\ & e_2 & -& \,-\,\\
\,-\, & \,e_3\ & \,-\,& \,-\,\\
\,-\, & \,e_4\ & \,-\,& \,-\,\\
\end{bmatrix}
\begin{bmatrix}
x \\
y \\
f \\
1
\end{bmatrix}=\begin{bmatrix}
nx \\
\\
ny \\
\\
f \\
\\
f\\
\end{bmatrix}
\;\;\;\;(2)
$

$\begin{bmatrix}
\,-\, & \,e_1\, & \,-\, & \,-\,\\
\,-\ & e_2 & -& \,-\,\\
\,-\, & \,e_3\ & \,-\,& \,-\,\\
\,-\, & \,e_4\ & \,-\,& \,-\,\\
\end{bmatrix}
\begin{bmatrix}
x \\
y \\
z \\
1
\end{bmatrix}=\begin{bmatrix}
nx \\
\\
ny \\
\\
[0, z]\\
\\
z\\
\end{bmatrix}
\;\;\;\;(3)
$


我们从第一个式子中可以知道


$\begin{bmatrix}
\,-\, & \,e_3\ & \,-\,& \,-\,\\
\end{bmatrix}
\begin{bmatrix}
x \\
y \\
n \\
1
\end{bmatrix}=0
$

从第二个式子中可以知道

$\begin{bmatrix}
\,-\, & \,e_3\ & \,-\,& \,-\,\\
\end{bmatrix}
\begin{bmatrix}
x \\
y \\
f \\
1
\end{bmatrix}=f
$

假设 $e_3$ 是 $(\;a,\;b,\;c,\;d\;)$，那么你就可以去通过二维方程解得
$e_3 = (\;0,\;0,\;\dfrac{f}{f - n},\;\dfrac{nf}{n - f}\;)$

同理你可以去推导出 $e1 = (\;n, \;0, \;0, \;0\;)$, $e2 = (\;0, \;n, \;0, \;0\;)$，$e4 = (\;0, \;0, \;1, \;0\;)$，
那么拼起来的矩阵就是如下的：

$\begin{bmatrix}
\,n\, & \,0\, & \,0\, & \,0\,\\
\,0\ & n & 0& \,0\,\\
\,0\, & \,0\ & \,\dfrac{f}{f - n}\,& \,\dfrac{nf}{n - f}\,\\
\,0\, & \,0\ & \,1\,& \,0\,\\
\end{bmatrix}
$

但是还有个问题，那就是我们在 $z$ 方向归一化到 $[0, 1]$ 范围，但是 $x$， $y$ 方向并没有进行归一化，以 $x$ 为例子，你看下图，

![alt text](images/img_proj.png)

前面提过 $P$ 点是在视锥体里面，是有 $x_{max}$ 和 $x_{min}$ 的（为了更加的那，这里是设定了视锥体的 $x$ 是对称的， $x_{max} = -x_{min}$ ），比如上图的$B$ 和 $C$ 点，我们目前是把他们映射到 $D$ 和 $E$ 点，但是前面推导的结果我们知道，$D_{x} = nx_{max}$ ( 我们只考虑齐次化之前,反正z值最后都会被除掉 )，而这个值是个定值，我们希望归一化，也就是把线段 $DE$ 压缩，比如压缩成 $[-1, 1]$，那么我们前面的矩阵中的 $e1$ 就要除以 $x_{max}$


$\begin{bmatrix}\,-\, & \,e_1\ & \,-\,& \,-\,\\\end{bmatrix} = 
= \begin{bmatrix}\,\dfrac{n}{x_{max}}\, & \,0\ & \,0\,& \,0\,\\\end{bmatrix}
$

同理 $y$ 方向也只是除以一个 $y_{max}$，最后整个矩阵就是 

$\begin{bmatrix}
\,\dfrac{n}{x_{max}}\, & \,0\, & \,0\, & \,0\,\\
\,0\ & \dfrac{n}{y_{max}} & 0& \,0\,\\
\,0\, & \,0\ & \,\dfrac{f}{f - n}\,& \,\dfrac{nf}{n - f}\,\\
\\
\,0\, & \,0\ & \,1\,& \,0\,\\
\end{bmatrix}
$

看到这里，其实你也可以算出变换并且除 $z$ 操作后，得到的 

$z' = (\dfrac{zf}{f - n} + \dfrac{nf}{n - f}) / z = \dfrac{f - \dfrac{nf}{z}}{f - n}$

也就是 $z'$ 是和 ${ \dfrac{1}{z} }$ 线性相关的，并且 $z$ 越大， $z'$ 越大。

<br>
<br>

# 一些注意点

在 PROJECT Matrix 推导过程中，你会在网上看到各种不一样的计算方式，其实这跟我们假定的一些条件有关系，比如下面的

https://observablehq.com/@musixnotmusic/perspective-projection-one

https://www.zhihu.com/question/47219652

可以对比知道哪些不同

<br>
<br>

# VIEW PORT 

最后是视窗变换，我们前面经过 MVP 后，得到的是一个 $[-1, 1]\times[-1, 1]\times[0, 1]$ 的 NDC，我们需要把 NDC 转成 VIEW PORT，他的空间是 $[0, W]\times[H, 0]\times[0, 1]$，也就只是缩放平移 $x, y$ 方向的值，而没有修改 $z$ 相关的操作，不过 VIEW PORT 中的坐标系方向是有点不一样的， 他是正常的图像坐标系，原点在左上角，所以，对于 $x$ 方向，目标是，$-1$ 映射到 $0$，$1$ 映射到 $W$, 而 $y$ 方向，目标有点不同，我们想要的是 $-1$ 映射到 $H$，而 $1$ 映射到 $0$。

那么应该如何左上述的变换？由于我们的矩阵设计中，$ [s, t] $，$s$ 表示 缩放，$t$ 表示平移，他的变换顺序必须是，缩放后再平移，所以这里我们按照这个顺序来变换上面的点

先看 $x$ 的初始范围 $[-1, 1]$，缩放 $\dfrac{W}{2}$ 倍，得到 $[-\dfrac{W}{2}, \dfrac{W}{2}]$，然后往右平移 $\dfrac{W}{2}$，得到 $[0, W]$。

然后，$y$ 的初始范围是 $[-1, 1]$，缩放 $-\dfrac{H}{2}$ 倍，得到 $[\dfrac{H}{2}, -\dfrac{H}{2}]$，然后往上平移 $\dfrac{W}{2}$，得到 $[H, 0]$。

因此 VIEWPORT MATRIX 就是

$\begin{bmatrix}
\,\dfrac{W}{2}\, & \,0\, & \,0\, & \,\dfrac{W}{2}\,\\
\\
\,0\ & -\dfrac{H}{2} & 0& \,\dfrac{H}{2}\,\\
\\
\,0\, & \,0\ & \,1\,& \,0\,\\
\\
\,0\, & \,0\ & \,0\,& \,1\,\\
\end{bmatrix}
$

